{% extends 'base.html' %}
{% load staticfiles %}

{% block head %}
    <!-- Select2 -->
    <link rel="stylesheet" href="{% static 'AdminLTE/bower_components/select2/dist/css/select2.min.css' %}">
    <link rel="stylesheet" href="{% static 'jquery-confirm/dist/jquery-confirm.min.css' %}">
{% endblock %}

{% block content-header %}
    <h1>详细信息</h1>
{% endblock %}

{% block content %}
    <form class="form-horizontal">
        {% csrf_token %}
        <div class="box-body">
            <div class="form-group ">
                <label class="col-sm-2 control-label ">
                    用户名称
                </label>
                <div class="col-sm-10">
                    <input name="username" class="form-control" type="text"
                           value="{{ user.username }}">
                    <span class="help-block">Required. 150 characters or fewer. Letters, digits and @/./+/-/_ only.</span>
                </div>
            </div>
            <div class="form-group ">
                <label class="col-sm-2 control-label ">
                    手机号码
                </label>
                <div class="col-sm-10">
                    <input name="mobile" class="form-control" type="number"
                           value="{{ user.mobile }}">
                </div>
            </div>
            <div class="form-group horizontal-checkbox ">
                <label class="col-sm-2 control-label ">
                    超级管理员
                </label>
                <div class="col-sm-10">

                    <select class="form-control select2" name="is_superuser" style="width: 100%;">
                        {% if user.is_superuser %}
                            <option selected="selected" value="1">是</option>
                            <option value="0">否</option>
                        {% else %}
                            <option value="1">是</option>
                            <option selected="selected" value="0">否</option>
                        {% endif %}
                    </select>

                </div>
            </div>
            <div class="form-group horizontal-checkbox ">
                <label class="col-sm-2 control-label ">
                    是否激活
                </label>
                <div class="col-sm-10">

                    <select class="form-control select2" name="is_active" style="width: 100%;">
                        {% if user.is_active %}
                            <option selected="selected" value="1">是</option>
                            <option value="0">否</option>
                        {% else %}
                            <option value="1">是</option>
                            <option selected="selected" value="0">否</option>
                        {% endif %}
                    </select>

                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-2 control-label ">
                    所属组
                </label>
                <div class="col-sm-10">
                    <select class="form-control select2" multiple="multiple" name="groups" style="width: 100%;">
                        {% for group in groups %}
                            {% if group in user.groups.all %}
                                <option value="{{ group.id }}" selected>{{ group }}</option>
                            {% else %}
                                <option value="{{ group.id }}">{{ group }}</option>
                            {% endif %}
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-2 control-label ">
                    用户权限
                </label>
                <div class="col-sm-10">
                    <select class="form-control select2" multiple="multiple" name="user_permissions"
                            style="width: 100%;">
                        {% for permission in permissions %}
                            {% if permission in user.user_permissions.all %}
                                <option value="{{ permission.id }}" selected>{{ permission }}</option>
                            {% else %}
                                <option value="{{ permission.id }}">{{ permission }}</option>
                            {% endif %}
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" onclick="history.go(-1)">返回</button>
                <button type="button" class="btn btn-primary pull-right"
                        onclick="updateUser()">确认修改
                </button>
            </div>
        </div>
        <!-- /.box-body -->
    </form>
{% endblock %}

{% block js %}
    <!-- Select2 -->
    <script src="{% static 'AdminLTE/bower_components/select2/dist/js/select2.full.min.js' %}"></script>

    <script src="{% static 'jquery-confirm/dist/jquery-confirm.min.js' %}"></script>

    <script>
        $(function () {
            //Initialize Select2 Elements
            $('.select2').select2()
        });

        function updateUser() {
            let data = $('.form-horizontal').serialize();
            $.ajax({
                url: "/users/user/{{ user.id }}/",
                type: "POST",
                data: data,
                beforeSend: function (xhr) {
                    xhr.setRequestHeader('X-CSRFToken', '{{ csrf_token }}')
                },
                success: function () {
                    $.confirm({
                        title: 'Tips',
                        type: 'green',
                        content: '修改成功！',
                        buttons: {
                            'OK': function () {
                                window.location.href = '/users/user_list/'
                            }
                        }
                    });
                },
                error: function (response) {
                    $.alert({
                        title: 'Tips',
                        type: 'red',
                        content: '修改失败！' + response.responseText,
                    })
                }
            })
        }
    </script>
{% endblock %}